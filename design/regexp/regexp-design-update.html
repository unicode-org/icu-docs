<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<!-- Copyright (C) 2007 International Business Machines Corporation, Google,  and others.  All Rights Reserved -->
<head>
</head>
<body>
<h2>
  ICU Regular Expression Revisions for Improved Java Compatibility
</h2>

<br>

Here is a proposal for an update to ICU regular expressions to improve
compatibility with Java.&nbsp; ICU is actually pretty close to Java already, and
these changes will clean up most of the remaining differences.<br>

<br>

9/28/2007<br>

Andy Heninger<br>

<h3>
  Modes
</h3>

ICU could support multiple modes for regular expressions - a Java compatible
mode, a Perl compatible mode, a classic ICU mode, and possibly more.&nbsp;
However, this complicates both the API and the implementation.&nbsp; And there
is no "good" choice for the default mode -- if it is not classic ICU we run the
risk of breaking existing users anyhow, and if it is classic ICU we continue to
trip up users with ICU's non-standard behavior.<br>

<br>

The bottom line:&nbsp; No modes.&nbsp; All of ICU's existing Regular Expression
functionality remains available, with some minor syntax differences.<br>

<br>

<h3>
  Proposed ICU Regular Expression Syntax
</h3>

Most of the syntax for ICU regular expressions will exactly follow the Java
specification, and it isn't repeated here.<br>

Because there are differences with Java in the area of character class
expressions, the proposed ICU syntax is described here.<br>

<br>

<p>
  <b> ICU Set Expressions </b>
</p>

<br>

Here is the approximate grammar of an ICU bracket expression.&nbsp; There are
some constraints that are not easily expressed in this kind of syntax notation
that are described in text at the end.<br>

<br>

<br>

<div>
  
<table id="gov." border="1" bordercolor="#666666" cellpadding="3" cellspacing="0">

    <tbody>

    <tr>

      <td>
        set expression<br>

      </td>

      <td>
        '['&nbsp; '^'?&nbsp; ']'?&nbsp; [intersection or difference]?&nbsp; ']'<br>

      </td>

      <td>
        notes 1, 2<br>

      </td>

    </tr>

    <tr>

      <td>
        intersection or difference<br>

      </td>

      <td>
        term (('&amp;' | '&amp;&amp;' | '-' | '--') term)*<br>

      </td>

      <td>
        note 3, 4<br>

      </td>

    </tr>

    <tr>

      <td>
        term<br>

      </td>

      <td>
        (property expression |<br>

        range |<br>

        single char |<br>

        set expression) +<br>

        <br>

      </td>

      <td><br>

      </td>

    </tr>

    <tr>

      <td>
        property expression<br>

      </td>

      <td>
        '\p{' property '}' |<br>

        '\P{' property '}' |<br>

        '[:' property ':]'&nbsp; |<br>

        '\d' | '\D' |<br>

        '\s' | '\S' |<br>

        '\w | '\W'<br>

      </td>

      <td>
        <br>

      </td>

    </tr>

    <tr>

      <td>
        range<br>

      </td>

      <td>
        single char '-' single char<br>

      </td>

      <td>
        note 5<br>

      </td>

    </tr>

    <tr>

      <td>
        single char<br>

      </td>

      <td>
        x&nbsp;&nbsp;&nbsp; The character x, for all characters other than '\'<br>

        \\&nbsp;&nbsp;&nbsp; The backslash character<br>

        \x&nbsp;&nbsp;&nbsp; For ASCII letters and digits, either<br>

        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; a special
        meaning, listed separately, or<br>

        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; an error.<br>

        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; For characters other than ASCII letters
        and digits,<br>

        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; x, the character
        itself.<br>

        <br>

        \uhhhh or \Uhhhhhhhh&nbsp;&nbsp;<br>

        \N{Unicode Character Name}<br>

        \0ooo&nbsp;&nbsp;&nbsp; (1 to 3 octal digits)<br>

        \t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (tab)<br>

        \n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (new line)<br>

        \r&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (carriage return<br>

        \f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (form feed)<br>

        \a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (bell, \u0007)<br>

        \e&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (escape)<br>

        \cx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; the control character
        corresponding to x<br>

        <br>

        <br>

      </td>

      <td>
        note 6<br>

      </td>

    </tr>

    <tr>

      <td>
        property<br>

      </td>

      <td>
        Anything recognized by the ICU property APIs, plus<br>

        &nbsp;- POSIX compatibility property names from<br>

        &nbsp;&nbsp;
        http://www.unicode.org/reports/tr18/#Compatibility_Properties<br>

        &nbsp;- Alternate names for Unicode Blocks of the form<br>

        &nbsp;&nbsp; InBlockName<br>

        <br>

      </td>

      <td>
        <br>

      </td>

    </tr>

    
  </tbody>
  
</table>

  <br>

  Notes<br>

  
<ol>

    <li>
      Negation (^) can only appear immediately following an opening bracket, and
      applies to the entire expression within the matching brackets.&nbsp; In
      other locations within a set expression0, a '^' is treated as a literal
      character.
    </li>

    <li>
      A ']' as the first character in a set is treated as a literal, and does
      not close the set.&nbsp; No other characters have special behavior in this
      opening position.
    </li>

    <li>
      A '-' or '&amp;' is recognized as a difference or intersection operator
      only when appearing between closing and opening brackets.&nbsp; Not that a
      '-' can mean three different things, depending on the context:&nbsp; 1) a
      set difference operation, as described here, 2) part of a range, i.e.
      [a-z], and 3) a character literal.&nbsp;&nbsp; The single '-' and '&amp;'
      forms of the set difference and intersection are included for
      compatibility with original ICU behavior.
    </li>

    <li>
      Intersection and Difference operators have the same precedence and are
      evaluated left to right.<br>

    </li>

    <li>
      Ranges are based on Unicode code point values.&nbsp; A range with the
      lower bound greater than the upper bound is an error.</li>
  <li>This set of single character escapes exactly matches those supported by Java.</li>

  
</ol>

  <br>

  <br>

  Precedence of Character Class operators<br>

  <br>

  
<div>
    
<table id="dwkq" border="1" bordercolor="#666666" cellpadding="3" cellspacing="0">

      <tbody>

      <tr>

        <td>
          1&nbsp;&nbsp;<br>

        </td>

        <td>
          escaping<br>

        </td>

        <td>
          \$<br>

        </td>

      </tr>

      <tr>

        <td>
          2<br>

        </td>

        <td>
          grouping<br>

        </td>

        <td>
          [...]<br>

        </td>

      </tr>

      <tr>

        <td>
          3<br>

        </td>

        <td>
          range<br>

        </td>

        <td>
          a-z<br>

        </td>

      </tr>

      <tr>

        <td>
          4<br>

        </td>

        <td>
          union<br>

        </td>

        <td>
          \p{Letter}\p{Number}<br>

        </td>

      </tr>

      <tr>

        <td>
          5<br>

        </td>

        <td>
          intersection and difference&nbsp;&nbsp;<br>

        </td>

        <td>
          \p{Letter}&amp;&amp;\p{script=Hebrew}<br>

        </td>

      </tr>

      
  </tbody>
    
</table>

  </div>

  <br>

  <br>

  Differences between this Proposal and Java<br>

  <br>

  
<ol>

    <li>
      Recognize&nbsp; POSIX style syntax for character classes, e.g.
      [:Alpha:].&nbsp; This is in addition to the Java/Perl style of
      \p{Alpha}&nbsp;
    </li>

    <li>
      POSIX compatibility character classes operate over the entire Unicode
      range; they are not limited to ASCII.
    </li>

    <li>
      Add support for all Unicode properties.<br>

    </li>

    <li>
      Add the set difference operator '--'.&nbsp; Incompatibility is minimal,
      the operator would look like part of a range expression in Java, and that
      is highly improbable.<br>

    </li>

    <li>
      No support for CANON_EQ, but Java's support appears to be broken anyhow.
    </li>

    <li>
      Add \N{UNICODE CHARACTER NAME}
    </li>

    <li>
      Add \X which is a test for a grapheme cluster boundary.<br>

    </li>

  
</ol>

  <br>

  <br>

  <br>

  Differences with classic ICU<br>

  <br>

  
<ol>

    <li>
      Backslash escapes of ASCII letters and digits with no special meaning are
      taken as the literal ASCII character in old ICU.&nbsp; (Perl behavior)
    </li>

    <li> No ICU single quoting conventions in set expressions.
&nbsp;In old ICU, text within single quotes within a set expression is
always treated as literal characters. &nbsp;<br>

    </li>

    <li>Auto-escape of ']' at the first position in a set.</li>
  <li>\b and \v (backspace and vertical tab) are not recognized escapes within set expressions.</li>

    <li> No strings in sets.&nbsp; Strings in ICU sets were enclosed
in {curly brackets}. &nbsp;They were recognized syntactically, then
ignored during matching.&nbsp; </li>

    <li>
      &amp;&amp; and -- are recognized in addition to than &amp; and -; operands
      do not need to be bracketed for the &amp;&amp; and -- forms.
    </li>

    <li>
      Precedence of operators in sets: in original ICU the operators '&amp;',
      '-' and the implicit union are all equal, and are evaluated left to
      right.&nbsp; In Java, the implicit union has higher precedence than
      '&amp;'.&nbsp;<br>

    </li>

    <li>
      \p{InBlockName} for added for Unicode Blocks, in addition to the standard
      form for block names
    </li>

    <li> $ at the end of a set was not recognized as a literal in old
ICU. &nbsp;(The trailing $ had special meaning for sets used with
transliterators; it was ignored by regular expressions.) </li>

    <li>
      Change \X (Grapheme Cluster) to be a zero width boundary test rather than
      a matching operation.&nbsp; I believe we got it wrong the first time, and
      this seems like an opportune time to fix it.
    </li>

    <li>
      A '-' in a set will be treated as a literal if it can not be interpreted
      as a set difference operator.<br>

    </li>

  
</ol>

  <br>

  Differences with Perl<br>
<br>
<ol>
  <li>Perl will recognize \p{properties} without the brackets. &nbsp;\pL for letters, for example.</li>
  <li>No&nbsp;<code class="inline">(?&gt;pattern)</code></li>
  <li>Octal Escaping and BackReferences. &nbsp; In Java and in this
proposal, octal escapes must begin with \0, to distinguish them from
back references.&nbsp;</li>
  <li>Perl supports conditional expressions like&nbsp; <span style="font-style: italic;">(?(condition)A|B) </span>; ICU does not</li>
  <li>ICU supports possessive quantifiers, and set intersection (&amp;&amp;) and difference (--); Perl does not.</li>
</ol>

  <br>

</div>

<br>
</body>
</html>
