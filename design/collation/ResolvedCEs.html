<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="en-us">
<head>

  <meta content="Copyright &copy; 2006, IBM Corp. All Rights Reserved." name="copyright">

  <meta content="text/html; charset=UTF-8" http-equiv="content-type">
  <title>Resolved Collation Elements</title>


  <style type="text/css">
.code { font-family: Courier New,Courier,monospace;
font-size: medium;
}
pre { border: 1px solid rgb(0, 0, 0);
background-color: rgb(204, 204, 204);
display: table-cell;
}
body { font-family: Arial,Helvetica,sans-serif;
}
ol { list-style-type: decimal;
list-style-position: outside;
}
ul { list-style-position: outside;
list-style-type: square;
}
  </style>
  <meta content="Vladimir Weinstein" name="author">

  <meta content="Design document for resolved collation elements" name="description">

</head>


<body>

<h1 style="text-align: center;">Resolved Collation Element
Iteration</h1>

<div style="text-align: center;"><span style="color: rgb(255, 0, 0);">*** draft ***</span><br>

Vladimir Weinstein<br>

01/26/2006</div>

<p>UCA defines a many-to-many transformation from code points to
Collation Elements (CE). CEs are then used as representatives of
strings that will yield culturally correct results when compared. They
are used to produce sort keys, direct compare strings and in string
search. CE processing generally consists of two stages:</p>

<ol>

  <li>performing a transformation from codepoints to CEs</li>

  <li>processing CEs according to the collator object's settings</li>

</ol>

<p>Current ICU implementation uses common code for the first
step, while the second step is (for performance reasons) handled by the
individual procedures (sort key generation, comparison, string search).
There is a public interface that allows access to raw CEs.&nbsp;</p>

<p>Raw CEs are not very usable to end users because:</p>

<ul>

  <li>Raw CEs do not reflect collator object settings (strength
level, upper first, alternate handling etc.)</li>

  <li>Raw CEs reflect internal implementation details - a CE can
be stored as one or more 32-bit units but iteration returns single CEs</li>

</ul>

<p>A concept that would allow iteration over complete processed
CEs would be valuable as it would provide end users with possibility of
using CEs for hashing or different kinds of search implementations.</p>

<p>This document proposes a concept of a resolved CE, which is a
complete
CE &nbsp;(no continuations) processed according to collator's
current settings:</p>

<ul>

  <li>
contains the number of levels as specified by collator
(primary to quaternary)
  </li>

  <li>
contains case level bits, if case level is turned on
  </li>

  <li>
primary CE values are properly shifted if alternate
handling is set to shifted
  </li>

  <li>
Hiragana sorts before Katakana on quaternary level if
hiragana quaternary processing is specified
  </li>

  <li>
tertiary information on tertiary and case levels is
processed according to the case first setting
  </li>

</ul>

<p>French secondary setting <span style="font-weight: bold;">does
not</span> change values of resolved CEs. This setting cannot be
applied on the individual CE level.</p>

<h2>Data Structure</h2>

<p>Proposed data structure is as following:</p>

<pre>unsigned int primaryCEValue;<br>unsigned int secondaryCEValue;<br>unsigned int tertiaryCEValue;<br>unsigned int quaternaryCEValue;<br>unsigned byte caseLevelCEValue;</pre>

<p>Contents of all the values are left aligned, due to ICU's
implementation of the UCA which uses variable length fractional CE
weights. Furthermore, ICU's implementation limits the size of the
weights to 32 bits, therefore the widths of the fields are 32 bits.</p>

<p>Resolved CE values can then be used for hashing or other
purposes.</p>

<h2>API Considerations</h2>

<p>ICU already provides a framework for iteration over CEs - in
ICU4C we
have <span class="code">UCollationElements</span>,
and in ICU4J there is <span class="code">CollationElementIterator</span>
class. &nbsp;These framework elements are designed to handle text
and iterate over it, producing collation elements. It is only natural
to base the resolved CE APIs off these. &nbsp;</p>

<p>C API could define the following:</p>

<pre>typedef struct UResolvedCE {<br> uint32_t primaryCEValue;<br> uint32_t secondaryCEValue;<br> uint32_t tertiaryCEValue;<br> uint32_t quaternaryCEValue;<br> uint32_t reserved1;<br> uint32_t reserved2;<br> uint8_t caseLevelCEValue;<br> uint8_t padding1;<br> uint16_t padding2;<br>} UResolvedCE;<br><br>U_DRAFT int32_t U_EXPORT2 <br>ucol_nextResolvedCE(UCollationElements *elems, UResolvedCE *fillIn, UErrorCode *status);<br></pre>

<p>First argument is the service object, second is a structure
that needs to be filled in. Function returns a number of CEs that were
processed in order to calculate the resolved CE.</p>

<p>Java API could similarly have:</p>

<pre>package com.ibm.icu.text;<br>public class ResolvedCE {<br>&nbsp;private int primaryCEValue;<br> private int secondaryCEValue;<br> private int tertiaryCEValue;<br> private int quaternaryCEValue;<br> private byte caseLevelCEValue;<br><br> public int getPrimaryCEValue();<br> public int getSecondaryCEValue();<br> public int getTertiaryCEValue();<br> public int getQuaternaryCEValue();<br> public byte getCaseLevelValue();<br><br> public ResolvedCE(int primary, int secondary, int tertiary, int quaternary, byte caseLevel);<br> public setValues(int primary, int secondary, int tertiary, int quaternary, byte caseLevel);<br>}<br></pre>

<p>coupled with a method on <span class="code">CollationElementIterator</span>:</p>

<pre>public int next(ResolvedCE fillIn); </pre>

<h2>References:</h2>

<ol>

  <li>
Unicode Technical Standard #10 - Unicode Collation
Algorithm: <a href="http://www.unicode.org/reports/tr10/">http://www.unicode.org/reports/tr10/</a>
  </li>

  <li>
ICU collation design document: <a href="http://dev.icu-project.org/cgi-bin/viewcvs.cgi/%7Echeckout%7E/icuhtml/design/collation/ICU_collation_design.htm">http://dev.icu-project.org/cgi-bin/viewcvs.cgi/~checkout~/icuhtml/design/collation/ICU_collation_design.htm</a>
  </li>

</ol>

<p align="center"></p>

<hr style="width: 100%; height: 2px;">
<p align="center"><i>Copyright &copy; 2006, IBM
Corp. All Rights Reserved.</i></p>

</body>
</html>
