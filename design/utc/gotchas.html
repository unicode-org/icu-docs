<html>

<head>
<!-- Copyright IBM, 2005 -->
<meta http-equiv="Content-Language" content="en-us">
<meta name="GENERATOR" content="Microsoft FrontPage 5.0">
<meta name="ProgId" content="FrontPage.Editor.Document">
<meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<title>Unicode Gotchas</title>
<style>
<!--
body         { font-family: Arial Unicode MS, Code2000 }
span.box         { border: 1px solid #0000FF }
span.highlight { font-weight: bold; background-color: #DDD}
.sample        { ; padding:0.25em; border:1px solid #000000; font-size:150%; background-color:#99FF99 }
-->
</style>
</head>

<body>

<h1 align="center">Globalization Gotchas</h1>
<p>I'm preparing a presentation for the next Unicode conference in March, and have been thinking 
about doing one on the pitfalls that people stumble into when using Unicode in practice. I have the 
following draft list, and would like to collect others.</p>
<p>If you have any suggestions for additions or improvements, I would appreciate them!</p>
<table border="0" cellpadding="0" cellspacing="0" style="border-collapse: collapse" bordercolor="#111111" width="100%" id="AutoNumber6">
  <tr>
    <td>
    <h2>General</h2>
    </td>
    <td align="right" valign="top" width="1%" nowrap>
    <p class="sample">text &#8594; <font face="Webdings">i</font></td>
  </tr>
</table>
<p></p>
<blockquote>
  <p>&#9760; Unicode encodes characters, not glyphs: U+0067 &#8594; <font face="Arial Narrow">g</font>
  <font face="Baskerville">g</font> <span style="font-variant: small-caps">g</span>
  <font face="Binner Gothic">g</font> <font face="Brush Script">g</font> <font face="Courier New">g</font>
  <font face="Times New Roman">g</font> <font face="Trebuchet MS">g</font> <font face="Impact">g</font>
  <i>g <font face="Times New Roman">g </font><b>g <font face="Times New Roman">g</font></b></i>...</p>
  <p>&#9760; Unicode does not encode characters by language: French and German <b><i>j</i></b> have the 
  same code point as English <b><i>j</i></b> even though all have different names and 
  pronunciations; likewise Chinese &#22823; (<i>da</i>) has the same code point as corresponding Japanese &#22823; 
  (<i>dai</i>). </p>
  <p></p>
  <p>&#9760; Names may be misleading: U+034F COMBINING GRAPHEME JOINER doesn't join graphemes. See the 
  names list, Unicode FAQ. </p>
  <p></p>
  <p>&#9760;&nbsp; Never use unassigned code points; those will be used in future versions of Unicode. If 
  you need your own characters, use private use or non-characters; there are plenty. (If your system 
  is running a back-level version of Unicode, you may get unassigned code points from later 
  versions.)</p>
  <p></p>
  <p>&#9760; A &quot;UCS-2&quot; implementation uses UTF-16 text, but doesn't support characters over U+10000; it 
  also may accidentally cause isolated surrogates.</p>
  <p></p>
  <p>&#9760; User-Interface language (menus, dialog, help-system,...) &#8800; Data language (body text, 
  spreadsheet cells).</p>
  <p>&#9760; <i>Character</i> means different things to different people: be sure to correctly distinguish 
  between code points, bytes, and user-perceived characters (grapheme clusters). </p>
  <p>&#9760; Some APIs/protocols will count lengths in code points, and others in bytes. Make sure you 
  don't mix them up. </p>
</blockquote>
<table border="0" cellpadding="0" cellspacing="0" style="border-collapse: collapse" bordercolor="#111111" width="100%" id="AutoNumber2">
  <tr>
    <td>
    <h2>User Input</h2>
    </td>
    <td align="right" valign="top" nowrap width="1%">
    <p class="sample"><font size="5" face="Wingdings">7</font><font size="5" face="Wingdings 2">:</font><font size="5"> 
    &#8594; text&nbsp; </font></td>
  </tr>
</table>
<blockquote>
  <p>&#9760; Higher-level programmers don't need to worry about this, unless they are doing their own text 
  input</p>
</blockquote>
<p></p>
<p></p>
<table border="0" cellpadding="0" cellspacing="0" style="border-collapse: collapse" bordercolor="#111111" width="100%" id="AutoNumber2">
  <tr>
    <td>
    <h2>Character Conversion</h2>
    </td>
    <td align="right" valign="top" nowrap width="1%">
    <p class="sample">text &#8206;&#8596; <span class="box">74</span> <span class="box">65</span>
    <span class="box">78</span> <span class="box">74</span>&nbsp; </td>
  </tr>
</table>
<blockquote>
  <p></p>
  <p>&#9760; Length in bytes may not be N * length in characters </p>
  <p></p>
  <p>&#9760; One character in charset X may not be one character in Unicode</p>
  <p></p>
  <p>&#9760; Always use &quot;shortest form&quot; UTF-8 to reduce security attacks</p>
  <p>&#9760; Not all text is correctly tagged with its charset, so character detection may be necessary. 
  But remember, it's always a guess.</p>
  <p>&#9760; IANA / MIME charset names are ill-defined: Vendors often convert same charset different ways. 
  Shift-JIS 0x5C &#8594; U+005C <i><b>or</b></i> U+00A5: different, unrelated characters with unrelated 
  glyphs.<br>
  &#9658; <a class="moz-txt-link-freetext" href="http://www.w3.org/TR/japanese-xml/">
  http://www.w3.org/TR/japanese-xml/</a><br>
  &#9658; <a class="moz-txt-link-freetext" href="http://icu.sourceforge.net/charts/charset/">
  http://icu.sourceforge.net/charts/charset/</a></p>
  <p></p>
</blockquote>
<table border="0" cellpadding="0" cellspacing="0" style="border-collapse: collapse" bordercolor="#111111" width="100%" id="AutoNumber1">
  <tr>
    <td>
    <h2>Text Analysis</h2>
    </td>
    <td align="right" valign="top" nowrap width="1%">
    <p class="sample">&nbsp;text &#8594; <font face="Webdings">i</font></td>
  </tr>
</table>
<blockquote>
  <h3>Grapheme Clusters </h3>
  <p></p>
  <p>&#9760; Don't limit API parameters to a single character. What users think of as a single character 
  (e.g. x&#776;) may be a sequence in Unicode. </p>
  <p></p>
  <p>&#9760; Combining characters always follow their base:&nbsp; x&#776; is&nbsp; x + <font SIZE="3">&#9676;&#776;</font>,
  <i class="moz-txt-slash">not<span class="moz-txt-tag"> </span></i>&nbsp;<font SIZE="3">&#9676;</font>&#776; + x
  </p>
  <p></p>
  <p>&#9760; Combining characters normally stack outwards:&nbsp; x<font SIZE="3">&#776;&#772;</font> is&nbsp; x +
  <font SIZE="3">&#9676;&#776; </font>+ <font SIZE="3">&#9676;&#772;, </font><i class="moz-txt-slash">not<span class="moz-txt-tag">
  </span></i>&nbsp;x + <font SIZE="3">&#9676;&#772;</font> + <font SIZE="3">&#9676;&#776;</font></p>
  <p></p>
  <p></p>
  <p></p>
  <h3>Properties </h3>
  <p></p>
  <p>&#9760; Use properties such as Alphabetic, not hard-coded lists: isAlphabetic() API; /p{Alphabetic} 
  in regex</p>
  <p></p>
  <p>&#9760; Some General Category properties aren't what you think: use White_Space (not Zs), Alphabetic 
  (not L)</p>
  <p>&#9760; Generally use Script instead of Block: not all Greek characters are in the Greek block.</p>
  <h3>Identifiers </h3>
  <p></p>
  <p>&#9760; When designing syntax, don't use characters outside of Pattern_Syntax for syntax characters; 
  don't use characters outside of Pattern_Whitespace for whitespace characters. </p>
  <p></p>
  <p>&#9760; Use XID_Start and XID_Continue as a basis for identifiers. Profiles may expand or narrow from 
  there.</p>
  <p>&#9760; Watch out for security attacks: using visual similarity to slip bogus text (e.g. counterfeit 
  URL’s) past human eyes (spoofing), for example writing “paypal.com” with a Cyrillic “a” to phish 
  for users’ account information.<br>
  &#9658; <a href="http://unicode.org/reports/tr36/">http://unicode.org/reports/tr36/</a> </p>
  <p></p>
  <p></p>
  <h3>Comparison: Searching, Sorting, Matching </h3>
  <p></p>
  <p>&#9760; There are <i><b>two</b></i> binary orders: codepoint/UTF-8/UTF-32 vs UTF16 order, where 
  U+10000 &lt; U+E000 (since U+10000 = <span class="box">D800</span> <span class="box">DC00</span>) </p>
  <p>&#9760; Only use binary order internally; no users expect A &lt; C<font SIZE="3">&#9676;&#807; </font>&lt; Z &lt; a &lt; z &lt; 
  Ç &lt; ä </p>
  <p></p>
  <p></p>
  <p>&#9760; Ordering depends on context and language </p>
  <p></p>
  <ul>
    <li>china &lt; China &lt; chinas </li>
    <li>ae &lt; æ &lt; af </li>
    <li>z &lt; æ <i>(Danish) </i></li>
    <li>c &lt; d &lt; ... k &lt; ch &lt; l <i>(Slovak) </i></li>
  </ul>
  <p></p>
  <p>&#9760; UCA Order is far better, basis for tailoring: a &lt; ä &lt; A &lt; Ç = C<font SIZE="3">&#9676;&#807; </font>&lt; z &lt; 
  Z<br>
  &#9658; <a class="moz-txt-link-freetext" href="http://unicode.org/reports/tr10/">
  http://unicode.org/reports/tr10/</a> </p>
  <p></p>
  <p>&#9760; Real Language-Sensitive Order requires tailoring on top of UCA<br>
  &#9658; <a class="moz-txt-link-freetext" href="http://unicode.org/cldr/">http://unicode.org/cldr/</a>
  </p>
  <p></p>
  <p></p>
  <p>&#9760; Don't mix up &quot;stable&quot; and &quot;deterministic&quot; sorting; they are very different.<br>
  &#9658; <a class="moz-txt-link-freetext" href="http://unicode.org/notes/tn9/">
  http://unicode.org/notes/tn9/</a> </p>
  <p></p>
  <p></p>
</blockquote>
<table border="0" cellpadding="0" cellspacing="0" style="border-collapse: collapse" bordercolor="#111111" width="100%" id="AutoNumber5">
  <tr>
    <td>
    <h2>Text Transformations</h2>
    </td>
    <td align="right" valign="top" nowrap width="1%">
    <p class="sample">text &#8594; TEXT, &#964;&#949;&#958;&#964;, …</td>
  </tr>
</table>
<blockquote>
  <h3>Normalization </h3>
  <p></p>
  <p>&#9760; The ordering of accents in a normalization form may not be the typical type-in order. </p>
  <p></p>
  <p>&#9760; Normalization is context independent; don't assume NFC(x + y) = NFC(x) + NFC(y) </p>
  <p></p>
  <p>&#9760; People assume that NFC always composes, but characters may <i>expand</i> in NFC. Here are the 
  current maximal expansion factors:</p>
  <p></p>
  <p></p>
  <p></p>
  <p></p>
  <table cellspacing="0" cellpadding="3" style="border-collapse: collapse" bordercolor="#111111" border="1">
    <tr>
      <th>Form</th>
      <th>UTF</th>
      <th>Exp.</th>
      <th colspan="2">Sample</th>
    </tr>
    <tr>
      <td>NFC</td>
      <td align="center">8</td>
      <td align="right">3X</td>
      <td align="center">&#119136;</td>
      <td align="right"><font face="monospace">U+1D160</font></td>
    </tr>
    <tr>
      <td>NFC</td>
      <td align="center">16, 32</td>
      <td align="right">3X</td>
      <td align="center">&#64300;</td>
      <td align="right"><font face="monospace">U+FB2C</font></td>
    </tr>
    <tr>
      <td>NFD</td>
      <td align="center">8</td>
      <td align="right">3X</td>
      <td align="center">&#912;</td>
      <td align="right"><font face="monospace">U+0390</font></td>
    </tr>
    <tr>
      <td>NFD</td>
      <td align="center">16, 32</td>
      <td align="right">4X</td>
      <td align="center">&#8066;</td>
      <td align="right"><font face="monospace">U+1F82</font></td>
    </tr>
    <tr>
      <td>NFKC/D</td>
      <td align="center">8</td>
      <td align="right">11X</td>
      <td rowspan="2" align="center">&#65018;</td>
      <td rowspan="2" align="right"><font face="monospace">U+FDFA</font></td>
    </tr>
    <tr>
      <td>NFKC/D</td>
      <td align="center">16, 32</td>
      <td align="right">18X</td>
    </tr>
  </table>
  <p>Trivia: In Unicode 4.0 there are exactly 3 characters that are different in all 4 normalization 
  forms: &#979;, &#980;, &#7835;</p>
  <p></p>
  <p></p>
  <h3>Case Conversion </h3>
  <p></p>
  <p>&#9760; As well as Lower and upper case, there is also title case: &#499; &#8596; &#497; &#8596; <span class="highlight">&#498;</span>
  </p>
  <p></p>
  <p>&#9760; Strings may expand: Flu<span class="highlight">ß</span> &#8594; FLU<span class="highlight">SS</span> 
  &#8594; flu<span class="highlight">ss</span> </p>
  <p></p>
  <p>&#9760; Casing is context-dependent: &#908;<span class="highlight">&#931;</span>&#927;<span class="highlight">&#931;</span> 
  &#8594; &#972;<span class="highlight">&#963;</span>&#959;<span class="highlight">&#962;</span> </p>
  <p></p>
  <p>&#9760; Casing may be language-dependent: <span class="highlight">i</span>stanbul &#8596;
  <span class="highlight">&#304;</span>STANBUL. But don't use language-dependent casing for 
  language-independent structures, like file-system B-Trees.</p>
  <p></p>
  <p></p>
  <p></p>
  <p></p>
  <p></p>
</blockquote>
<table border="0" cellpadding="0" cellspacing="0" style="border-collapse: collapse" bordercolor="#111111" width="100%" id="AutoNumber3">
  <tr>
    <td>
    <h2>Rendering </h2>
    </td>
    <td align="right" valign="top" nowrap width="1%">
    <p class="sample">&nbsp;text &#8594; <b><i><font face="Times New Roman">text </font></i></b>&#8594;
    <font face="Webdings">i</font></td>
  </tr>
</table>
<blockquote>
  <p>&#9760; Single glyph may result from multiple characters: <font face="Times New Roman">f + i
  <font SIZE="3">&#8594;</font> &#64257; </font></p>
  <p></p>
  <p>&#9760; Multiple glyphs may result from single character: <font SIZE="3">&#2965; + <span class="highlight">
  &#3018;</span> </font><font SIZE="3" face="Times New Roman">&#8594; </font>&#2965;&#3018;</p>
  <p></p>
  <p>&#9760; Don't assume that contiguous text = contiguous display: a b <span class="highlight">c</span> 
  &#8206;&#1488; &#8206;&#1489; &#8206;<span class="highlight">&#1490;</span> <font SIZE="3" face="Times New Roman">&#8594;</font><font SIZE="3"> 
  ab<span class="highlight">c&#1488;</span>&#1489;&#1490;</p>
  </font>
  <p>&#9760; Good rendering systems will handle customary type-in order for text plus canonical order. 
  Excellent ones will do any canonically-equivalent order, but those are rare.</p>
  <p>&#9760; Linebreak is not just breaking at spaces<br>
&nbsp;</p>
  <p></p>
  <p></p>
  <p></p>
  <p></p>
</blockquote>
<table border="0" cellpadding="0" cellspacing="0" style="border-collapse: collapse" bordercolor="#111111" width="100%" id="AutoNumber4">
  <tr>
    <td>
    <h2>Formatting/Parsing</h2>
    </td>
    <td align="right" valign="top" nowrap width="1%">
    <p class="sample"><span style="font-size: 18.0pt; font-family: Arial; color: black">1 234,00£</span> 
    &#8596; <font face="Monospace" style="font-size: 75%">&lt;GBP, 0.10011010010×2<sup>12</sup>&gt;</font></td>
  </tr>
</table>
<blockquote>
  <p></p>
  <p>&#9760; Formatting and parsing of dates, times, numbers, currencies, ... are locale-dependent. Use 
  APIs</p>
</blockquote>
<p></p>
<p></p>
<p>&nbsp;</div> </p>

</body>

</html>
