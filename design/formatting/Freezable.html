<!doctype HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!--Copyright 2005, IBM-->
<html>

<head>
<meta name="GENERATOR" content="Microsoft FrontPage 5.0">
<meta name="ProgId" content="FrontPage.Editor.Document">
<!-- Generated by javadoc (build 1.4.2_06) on Wed Nov 16 17:05:39 PST 2005 -->
<title>Freezable</title>
<meta NAME="keywords" CONTENT="com.ibm.icu.util.Freezable interface">
<link REL="stylesheet" TYPE="text/css" HREF="../../../../stylesheet.css" TITLE="Style">
<script type="text/javascript">
function windowTitle()
{
    parent.document.title="Freezable";
}
</script>
</head>

<body BGCOLOR="white" onload="windowTitle();">

<!-- ========= START OF TOP NAVBAR ======= --><a NAME="navbar_top">
<!-- --></a><a HREF="#skip-navbar_top" title="Skip navigation links"></a>
<table BORDER="0" WIDTH="100%" CELLPADDING="1" CELLSPACING="0" SUMMARY>
  <tr>
    <td COLSPAN="3" BGCOLOR="#EEEEFF" CLASS="NavBarCell1"><a NAME="navbar_top_firstrow">
    <!-- --></a>
    <table BORDER="0" CELLPADDING="0" CELLSPACING="3" SUMMARY>
      <tr ALIGN="center" VALIGN="top">
        <td BGCOLOR="#EEEEFF" CLASS="NavBarCell1"><a HREF="package-summary.html">
        <font CLASS="NavBarFont1"><b>Package</b></font></a>&nbsp;</td>
        <td BGCOLOR="#FFFFFF" CLASS="NavBarCell1Rev">&nbsp;<font CLASS="NavBarFont1Rev"><b>Class</b></font>&nbsp;</td>
        <td BGCOLOR="#EEEEFF" CLASS="NavBarCell1"><a HREF="class-use/Freezable.html">
        <font CLASS="NavBarFont1"><b>Use</b></font></a>&nbsp;</td>
        <td BGCOLOR="#EEEEFF" CLASS="NavBarCell1"><a HREF="package-tree.html">
        <font CLASS="NavBarFont1"><b>Tree</b></font></a>&nbsp;</td>
        <td BGCOLOR="#EEEEFF" CLASS="NavBarCell1"><a HREF="../../../../deprecated-list.html">
        <font CLASS="NavBarFont1"><b>Deprecated</b></font></a>&nbsp;</td>
        <td BGCOLOR="#EEEEFF" CLASS="NavBarCell1"><a HREF="../../../../index-files/index-1.html">
        <font CLASS="NavBarFont1"><b>Index</b></font></a>&nbsp;</td>
        <td BGCOLOR="#EEEEFF" CLASS="NavBarCell1"><a HREF="../../../../help-doc.html">
        <font CLASS="NavBarFont1"><b>Help</b></font></a>&nbsp;</td>
      </tr>
    </table>
    </td>
    <td ALIGN="right" VALIGN="top" ROWSPAN="3"><em></em></td>
  </tr>
  <tr>
    <td BGCOLOR="white" CLASS="NavBarCell2"><font SIZE="-2">&nbsp;<a HREF="../../../../com/ibm/icu/util/DateRule.html" title="interface in com.ibm.icu.util"><b>PREV 
    CLASS</b></a>&nbsp; &nbsp;<a HREF="../../../../com/ibm/icu/util/RangeValueIterator.html" title="interface in com.ibm.icu.util"><b>NEXT 
    CLASS</b></a></font></td>
    <td BGCOLOR="white" CLASS="NavBarCell2"><font SIZE="-2">
    <a HREF="../../../../index.html" target="_top"><b>FRAMES</b></a>&nbsp;&nbsp; &nbsp;<a HREF="Freezable.html" target="_top"><b>NO 
    FRAMES</b></a>&nbsp;&nbsp; &nbsp;<script type="text/javascript">
  <!--
  if(window==top) {
    document.writeln('<A HREF="../../../../allclasses-noframe.html"><B>All Classes</B></A>');
  }
  //-->
    </script> <noscript><A HREF="../../../../allclasses-noframe.html"><B>All Classes</B></A>
    </noscript></font></td>
  </tr>
  <tr>
    <td VALIGN="top" CLASS="NavBarCell3"><font SIZE="-2">SUMMARY:&nbsp;NESTED&nbsp;|&nbsp;FIELD&nbsp;|&nbsp;CONSTR&nbsp;|&nbsp;<a HREF="#method_summary">METHOD</a></font></td>
    <td VALIGN="top" CLASS="NavBarCell3"><font SIZE="-2">DETAIL:&nbsp;FIELD&nbsp;|&nbsp;CONSTR&nbsp;|&nbsp;<a HREF="#method_detail">METHOD</a></font></td>
  </tr>
</table>
<a NAME="skip-navbar_top"></a>
<!-- ========= END OF TOP NAVBAR ========= --><hr>
<!-- ======== START OF CLASS DATA ======== -->
<h2><font SIZE="-1">com.ibm.icu.util</font> <br>
Interface Freezable</h2>
<dl>
  <dt><b>All Superinterfaces:</b> </dt>
  <dd>java.lang.Cloneable</dd>
</dl>
<dl>
  <dt><b>All Known Implementing Classes:</b> </dt>
  <dd>
  <a HREF="../../../../com/ibm/icu/util/GlobalizationPreferences.html" title="class in com.ibm.icu.util">
  GlobalizationPreferences</a></dd>
</dl>
<hr>
<dl>
  <dt>public interface <b>Freezable</b></dt>
  <dt>extends java.lang.Cloneable</dt>
</dl>
<p></p>
<pre>  DRAFT
  Copyright (C) 2005, International Business Machines Corporation and
  others. All Rights Reserved.
 </pre>
<p>Provides a flexible mechanism for controlling access, without requiring that a class be 
immutable. Once locked, an object can never be unlocked, so it is thread-safe from that point 
onward. The implementation of both methods must be synchronized. Once the object has been locked, it 
must guarantee that no changes can be made to it. Any attempt to alter it must raise an 
UnsupportedOperationException exception. This means that when the object returns internal objects, 
or if anyone has references to those internal objects, that those internal objects must either be 
immutable, or must also raise exceptions if any attempt to modify them is made. Of course, the 
object can return clones of internal objects, since those are safe. </p>
<h2>Background</h2>
<p>There are often times when you need objects to be objects 'safe', so that they can't be modified. 
Examples are when objects need to be thread-safe, or in writing robust code, or in caches. If you 
are only creating your own objects, you can guarantee this, of course -- but only if you don't make 
a mistake. If you have objects handed into you, or are creating objects using others handed into 
you, it is a different story. It all comes down to whether you want to take the Blanche Dubois 
approach (&quot;depend on the kindness of strangers&quot;) or the Andy Grove approach (&quot;Only the Paranoid 
Survive&quot;). </p>
<p>For example, suppose we have a simple class: </p>
<pre> public class A {
 	protected Collection b;
 
 	protected Collection c;
 
 	public Collection get_b() {
 		return b;
 	}
 
 	public Collection get_c() {
 		return c;
 	}
 
 	public A(Collection new_b, Collection new_c) {
 		b = new_b;
 		c = new_c;
 	}
 }
 </pre>
<p>Since the class doesn't have any setters, someone might think that it is immutable. You know 
where this is leading, of course; this class is unsafe in a number of ways. The following 
illustrates that. </p>
<pre>  public test1(SupposedlyImmutableClass x, SafeStorage y) {
   &lt;font color=&quot;#0000FF&quot;&gt;    &lt;b&gt;// unsafe getter&lt;/b&gt;
   &lt;/font&gt;    A a = x.getA();
   Collection col = a.get_b();
   col.add(something);&lt;font color=&quot;#0000FF&quot;&gt; // a has now been changed, and x too
   &lt;/font&gt;
   &lt;font color=&quot;#0000FF&quot;&gt;&lt;b&gt;// unsafe constructor&lt;/b&gt;&lt;/font&gt;
   a = new A(col, col);
   y.store(a);
   col.add(something);&lt;font color=&quot;#0000FF&quot;&gt; // a has now been changed, and y too
  
   &lt;/font&gt;}
 </pre>
<p>There are a few different techniques for having safe classes. </p>
<ol>
  <li>Const objects. In C++, you can declare parameters const.</li>
  <li>Immutable wrappers. For example, you can put a collection in an immutable wrapper.</li>
  <li>Always-Immutable objects. Java uses this approach, with a few variations. Examples:
  <ol>
    <li>Simple. Once a Color is created (eg from R, G, and B integers) it is immutable.</li>
    <li>Builder Class. There is a separate 'builder' class. For example, modifiable Strings are 
    created using StringBuffer (which doesn't have the full String API available). Once you want an 
    immutable form, you create one with toString().</li>
    <li>Primitives. These are always safe, since they are copied on input/output from methods.</li>
  </ol>
  </li>
  <li>Cloning. Where you need an object to be safe, you clone it.</li>
</ol>
<p>There are advantages and disadvantages of each of these. </p>
<ol>
  <li>Const provides a certain level of protection, but since const can be and is often cast away, 
  it only protects against most inadvertent mistakes. It also offers no threading protection, since 
  anyone who has a pointer to the (unconst) object in another thread can mess you up.</li>
  <li>Immutable wrappers are safer than const in that the constness can't be cast away. But other 
  than that they have all the same problems: not safe if someone else keeps hold of the original 
  object, or if any of the objects returned by the class are mutable.</li>
  <li>Always-Immutable Objects are safe, but usage can require excessive object creation.</li>
  <li>Cloning is only safe if the object truly has a 'safe' clone; defined as one that <i>ensures 
  that no change to the clone affects the original</i>. Unfortunately, many objects don't have a 
  'safe' clone, and always cloning can require excessive object creation.</li>
</ol>
<h2>Freezable Model</h2>
<p>The <code>Freezable</code> model supplements these choices by giving you the ability to build up 
an object by calling various methods, then when it is in a final state, you can <i>make</i> it 
immutable. Once immutable, an object cannot <i>ever </i>be modified, and is completely thread-safe: 
that is, multiple threads can have references to it without any synchronization. If someone needs a 
mutable version of an object, they can use <code>cloneAsThawed()</code>, and modify the copy. This 
provides a simple, effective mechanism for safe classes in circumstances where the alternatives are 
insufficient or clumsy. (If an object is shared before it is immutable, then it is the 
responsibility of each thread to mutex its usage (as with other objects).) </p>
<p>Here is what needs to be done to implement this interface, depending on the type of the object.
</p>
<h3><b>Immutable Objects</b></h3>
<p>These are the easiest. You just use the interface to reflect that, by adding the following: </p>
<pre>  public class A implements Freezable {
   ...
   public final boolean isFrozen() {return true;}
   public final Object freeze() {return this;}
   public final Object cloneAsThawed() { return this; }
   }
 </pre>
<p>These can be final methods because subclasses of immutable objects must themselves be immutable. 
(Note: <code>freeze</code> is returning <code>this</code> for chaining.) </p>
<h3><b>Mutable Objects</b></h3>
<p>Add a protected 'flagging' field: </p>
<pre> protected boolean immutable;
 </pre>
<p>Add the following methods: </p>
<pre> public final boolean isFrozen() {
 	return frozen;
 };
 
 public Object freeze() {
 	frozen = true;
 	return this;
 }
 </pre>
<p>Add a <code>cloneAsThawed()</code> method following the normal pattern for <code>clone()</code>, 
except that <code>frozen=false</code> in the new clone. </p>
<p>Then take the setters (that is, any method that can change the internal state of the object), and 
add the following as the first statement: </p>
<pre> if (isFrozen()) {
 	throw new UnsupportedOperationException(&quot;Attempt to modify frozen object&quot;);
 }
 </pre>
<h4><b>Subclassing</b></h4>
<p>Any subclass of a <code>Freezable</code> will just use its superclass's flagging field. It must 
override <code>freeze()</code> and <code>cloneAsThawed()</code> to call the superclass, but normally 
does not override <code>isFrozen()</code>. It must then just pay attention to its own getters, 
setters and fields. </p>
<h4><b>Internal Caches</b></h4>
<p>Internal caches are cases where the object is logically unmodified, but internal state of the 
object changes. For example, there are const C++ functions that cast away the const on the &quot;this&quot; 
pointer in order to modify an object cache. These cases are handled by mutexing the internal cache 
to ensure thread-safety. For example, suppose that UnicodeSet had an internal marker to the last 
code point accessed. In this case, the field is not externally visible, so the only thing you need 
to do is to synchronize the field for thread safety. </p>
<h4>Unsafe Internal Access</h4>
<p>Internal fields are called <i>safe</i> if they are either <code>frozen</code> or immutable (such 
as String or primitives). If you've never allowed internal access to these, then you are all done. 
For example, converting UnicodeSet to be <code>Freezable</code> is just accomplished with the above 
steps. But remember that you <i><b>have</b></i> allowed access to unsafe internals if you have any 
code like the following, in a getter, setter, or constructor: </p>
<pre> Collection getStuff() {
 	return stuff;
 } // caller could keep reference &amp; modify
 
 void setStuff(Collection x) {
 	stuff = x;
 } // caller could keep reference &amp; modify
 
 MyClass(Collection x) {
 	stuff = x;
 } // caller could keep reference &amp; modify
 </pre>
<p>These also illustrated in the code sample in <b>Background</b> above. </p>
<p>To deal with unsafe internals, the simplest course of action is to do the work in the <code>
freeze()</code> function. Just make all of your internal fields frozen, and set the frozen flag. Any 
subsequent getter/setter will work properly. Here is an example: </p>
<pre> public Object freeze() {
 	if (!frozen) {
 		foo.freeze();
 		frozen = true;
 	}
 	return this;
 }
 </pre>
<p>If the field is a <code>Collection</code> or <code>Map</code>, then to make it frozen you have 
two choices. If you have never allowed access to the collection from outside your object, then just 
wrap it to prevent future modification. </p>
<pre> zone_to_country = Collections.unmodifiableMap(zone_to_country);
 </pre>
<p>If you have <i>ever</i> allowed access, then do a <code>clone()</code> before wrapping it. </p>
<pre> zone_to_country = Collections.unmodifiableMap(zone_to_country.clone());
 </pre>
<p>If a collection <i>(or any other container of objects)</i> itself can contain mutable objects, 
then for a safe clone you need to recurse through it to make the entire collection immutable. The 
recursing code should pick the most specific collection available, to avoid the necessity of later 
downcasing. </p>
<blockquote>
  <p><b>Note: </b>An annoying flaw in Java is that the generic collections, like <code>Map</code> or
  <code>Set</code>, don't have a <code>clone()</code> operation. When you don't know the type of the 
  collection, the simplest course is to just create a new collection: </p>
  <pre> zone_to_country = Collections.unmodifiableMap(new HashMap(zone_to_country));
 </pre>
</blockquote>
<p></p>
<p></p>
<hr>
<p>
<!-- ======== NESTED CLASS SUMMARY ======== -->
<!-- =========== FIELD SUMMARY =========== -->
<!-- ======== CONSTRUCTOR SUMMARY ======== -->
<!-- ========== METHOD SUMMARY =========== --><a NAME="method_summary">
<!-- --></a></p>
<table BORDER="1" WIDTH="100%" CELLPADDING="3" CELLSPACING="0" SUMMARY>
  <tr BGCOLOR="#CCCCFF" CLASS="TableHeadingColor">
    <td COLSPAN="2"><font SIZE="+2"><b>Method Summary</b></font></td>
  </tr>
  <tr BGCOLOR="white" CLASS="TableRowColor">
    <td ALIGN="right" VALIGN="top" WIDTH="1%"><font SIZE="-1"><code>&nbsp;java.lang.Object</code></font></td>
    <td><code><b><a HREF="../../../../com/ibm/icu/util/Freezable.html#cloneAsThawed()">cloneAsThawed</a></b>()</code>
    <br>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Provides for the clone operation.</td>
  </tr>
  <tr BGCOLOR="white" CLASS="TableRowColor">
    <td ALIGN="right" VALIGN="top" WIDTH="1%"><font SIZE="-1"><code>&nbsp;java.lang.Object</code></font></td>
    <td><code><b><a HREF="../../../../com/ibm/icu/util/Freezable.html#freeze()">freeze</a></b>()</code>
    <br>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Locks the object.</td>
  </tr>
  <tr BGCOLOR="white" CLASS="TableRowColor">
    <td ALIGN="right" VALIGN="top" WIDTH="1%"><font SIZE="-1"><code>&nbsp;boolean</code></font></td>
    <td><code><b><a HREF="../../../../com/ibm/icu/util/Freezable.html#isFrozen()">isFrozen</a></b>()</code>
    <br>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Determines whether the object has been locked or not.</td>
  </tr>
</table>
<p>&nbsp; </p>
<p>
<!-- ============ FIELD DETAIL =========== -->
<!-- ========= CONSTRUCTOR DETAIL ======== -->
<!-- ============ METHOD DETAIL ========== --><a NAME="method_detail">
<!-- --></a></p>
<table BORDER="1" WIDTH="100%" CELLPADDING="3" CELLSPACING="0" SUMMARY>
  <tr BGCOLOR="#CCCCFF" CLASS="TableHeadingColor">
    <td COLSPAN="1"><font SIZE="+2"><b>Method Detail</b></font></td>
  </tr>
</table>
<a NAME="isFrozen()">
<!-- --></a>
<h3>isFrozen</h3>
<pre>public boolean <b>isFrozen</b>()</pre>
<dl>
  <dd>Determines whether the object has been locked or not.
  <p></dd>
  <dd>
  <dl>
  </dl>
  </dd>
  <dd>
  <dl>
  </dl>
  </dd>
</dl>
<hr><a NAME="freeze()">
<!-- --></a>
<h3>freeze</h3>
<pre>public java.lang.Object <b>freeze</b>()</pre>
<dl>
  <dd>Locks the object.
  <p></dd>
  <dd>
  <dl>
  </dl>
  </dd>
  <dd>
  <dl>
    <dt><b>Returns:</b></dt>
    <dd>the object itself.</dd>
  </dl>
  </dd>
</dl>
<hr><a NAME="cloneAsThawed()">
<!-- --></a>
<h3>cloneAsThawed</h3>
<pre>public java.lang.Object <b>cloneAsThawed</b>()</pre>
<dl>
  <dd>Provides for the clone operation. Any clone is initially unlocked.
  <p></dd>
  <dd>
  <dl>
  </dl>
  </dd>
  <dd>
  <dl>
  </dl>
  </dd>
</dl>
<!-- ========= END OF CLASS DATA ========= --><hr>
<!-- ======= START OF BOTTOM NAVBAR ====== --><a NAME="navbar_bottom">
<!-- --></a><a HREF="#skip-navbar_bottom" title="Skip navigation links"></a>
<table BORDER="0" WIDTH="100%" CELLPADDING="1" CELLSPACING="0" SUMMARY>
  <tr>
    <td COLSPAN="3" BGCOLOR="#EEEEFF" CLASS="NavBarCell1"><a NAME="navbar_bottom_firstrow">
    <!-- --></a>
    <table BORDER="0" CELLPADDING="0" CELLSPACING="3" SUMMARY>
      <tr ALIGN="center" VALIGN="top">
        <td BGCOLOR="#EEEEFF" CLASS="NavBarCell1"><a HREF="package-summary.html">
        <font CLASS="NavBarFont1"><b>Package</b></font></a>&nbsp;</td>
        <td BGCOLOR="#FFFFFF" CLASS="NavBarCell1Rev">&nbsp;<font CLASS="NavBarFont1Rev"><b>Class</b></font>&nbsp;</td>
        <td BGCOLOR="#EEEEFF" CLASS="NavBarCell1"><a HREF="class-use/Freezable.html">
        <font CLASS="NavBarFont1"><b>Use</b></font></a>&nbsp;</td>
        <td BGCOLOR="#EEEEFF" CLASS="NavBarCell1"><a HREF="package-tree.html">
        <font CLASS="NavBarFont1"><b>Tree</b></font></a>&nbsp;</td>
        <td BGCOLOR="#EEEEFF" CLASS="NavBarCell1"><a HREF="../../../../deprecated-list.html">
        <font CLASS="NavBarFont1"><b>Deprecated</b></font></a>&nbsp;</td>
        <td BGCOLOR="#EEEEFF" CLASS="NavBarCell1"><a HREF="../../../../index-files/index-1.html">
        <font CLASS="NavBarFont1"><b>Index</b></font></a>&nbsp;</td>
        <td BGCOLOR="#EEEEFF" CLASS="NavBarCell1"><a HREF="../../../../help-doc.html">
        <font CLASS="NavBarFont1"><b>Help</b></font></a>&nbsp;</td>
      </tr>
    </table>
    </td>
    <td ALIGN="right" VALIGN="top" ROWSPAN="3"><em></em></td>
  </tr>
  <tr>
    <td BGCOLOR="white" CLASS="NavBarCell2"><font SIZE="-2">&nbsp;<a HREF="../../../../com/ibm/icu/util/DateRule.html" title="interface in com.ibm.icu.util"><b>PREV 
    CLASS</b></a>&nbsp; &nbsp;<a HREF="../../../../com/ibm/icu/util/RangeValueIterator.html" title="interface in com.ibm.icu.util"><b>NEXT 
    CLASS</b></a></font></td>
    <td BGCOLOR="white" CLASS="NavBarCell2"><font SIZE="-2">
    <a HREF="../../../../index.html" target="_top"><b>FRAMES</b></a>&nbsp;&nbsp; &nbsp;<a HREF="Freezable.html" target="_top"><b>NO 
    FRAMES</b></a>&nbsp;&nbsp; &nbsp;<script type="text/javascript">
  <!--
  if(window==top) {
    document.writeln('<A HREF="../../../../allclasses-noframe.html"><B>All Classes</B></A>');
  }
  //-->
    </script> <noscript><A HREF="../../../../allclasses-noframe.html"><B>All Classes</B></A>
    </noscript></font></td>
  </tr>
  <tr>
    <td VALIGN="top" CLASS="NavBarCell3"><font SIZE="-2">SUMMARY:&nbsp;NESTED&nbsp;|&nbsp;FIELD&nbsp;|&nbsp;CONSTR&nbsp;|&nbsp;<a HREF="#method_summary">METHOD</a></font></td>
    <td VALIGN="top" CLASS="NavBarCell3"><font SIZE="-2">DETAIL:&nbsp;FIELD&nbsp;|&nbsp;CONSTR&nbsp;|&nbsp;<a HREF="#method_detail">METHOD</a></font></td>
  </tr>
</table>
<a NAME="skip-navbar_bottom"></a>
<!-- ======== END OF BOTTOM NAVBAR ======= --><hr>

</body>

</html>
